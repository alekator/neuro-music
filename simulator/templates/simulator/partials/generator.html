{% load static %}
<div class="player-container">
    <h3>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–µ–π—Ä–æ–º—É–∑—ã–∫–∏</h3>
    <div id="result"></div>
    <audio id="audio-player" controls style="width: 100%">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç.
    </audio>
    <div class="player-controls">
        <span id="track-info"></span>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —ç–º–æ—Ü–∏–π -->
<div id="emotion-modal" class="modal">
    <div class="modal-content">
        <h2>üéµ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h2>
        
        <div class="question-block">
            <h3>1. –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</h3>
            <div class="likert-scale">
                <label>
                    <input type="radio" name="stress" value="1">
                    <span>üòä –°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ</span>
                </label>
                <label>
                    <input type="radio" name="stress" value="2">
                    <span>üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ</span>
                </label>
                <label>
                    <input type="radio" name="stress" value="3">
                    <span>üòü –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ</span>
                </label>
            </div>
        </div>

        <div class="question-block">
            <h3>2. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</h3>
            <div class="image-grid">
                <img src="{% static 'emotions/calm.jpg' %}" 
                     data-emotion="relax" 
                     alt="–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ">
                <img src="{% static 'emotions/happy.jpg' %}" 
                     data-emotion="happy" 
                     alt="–†–∞–¥–æ—Å—Ç—å">
                <img src="{% static 'emotions/sad.jpg' %}" 
                     data-emotion="sad" 
                     alt="–ì—Ä—É—Å—Ç—å">
            </div>
        </div>

        <button id="submit-emotion" class="nav-btn">
            üé∂ –ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
        </button>
    </div>
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loading">
    ‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—É–∑—ã–∫–∏...
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
        const audioPlayer = document.getElementById('audio-player');
        const modal = document.getElementById('emotion-modal');
        const trackInfo = document.getElementById('track-info');
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
        modal.style.display = 'block';

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        document.querySelectorAll('.image-grid img').forEach(img => {
            img.addEventListener('click', () => {
                document.querySelectorAll('.image-grid img')
                    .forEach(i => i.classList.remove('selected'));
                img.classList.add('selected');
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('submit-emotion').addEventListener('click', async () => {
            const stress = document.querySelector('input[name="stress"]:checked')?.value;
            const emotion = document.querySelector('.image-grid img.selected')?.dataset.emotion;

            if (!stress || !emotion) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ!');
                return;
            }

            try {
                document.getElementById('loading').style.display = 'block';
                modal.style.display = 'none';
                
                const response = await fetch(`/api/generate-music/?emotion=${emotion}&stress=${stress}`);
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
                
                const data = await response.json();
                
                trackInfo.textContent = `üéµ ${emotion.charAt(0).toUpperCase() + emotion.slice(1)} | ${data.metadata.tempo}BPM`;
                
                audioPlayer.src = data.mp3_url;
                audioPlayer.oncanplay = () => {
                    audioPlayer.play().catch(e => {
                        console.log("–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –ù–∞–∂–º–∏—Ç–µ play –Ω–∞ –ø–ª–µ–µ—Ä–µ.");
                    });
                };
                
                audioPlayer.onerror = () => {
                    trackInfo.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ';
                    console.error("Audio error:", audioPlayer.error);
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                trackInfo.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });
    });
</script>